# 概念

- NoSQL数据库是指基本不使用SQL语句的数据库
- 关系型数据库的价值：
  - 更加轻易的获取部分持久化数据
  - 更容易控制并发（ACID事务）
  - 因为标准的SQL语句，更容易应用程序集成
- 关系型数据库的弊病：
  - 阻抗失谐-----持久化的数据结构无法准确地表达应用程序在运行过程中产生的内存数据结构，导致数据从内存到数据库和数据库到内存的过程中需要应用程序需进行解释翻译
- 应用程序数据库
  - 将数据库封装在应用程序内部，不同应用程序通过web接口进行通信
- 集成数据库
  - 不同应用程序公用同一个数据库，应用程序直接通过数据库进行通信

## 为什么选择NoSQL

- 待处理的数据量很大，或者对数据访问的效率要求很高，从而必须将数据放在集群上
- 采用一种更为方便的交互方式来提高应用程序开发效率

# 聚合数据模型

- 数据模型：认知和操作数据时所用的模型。数据模型描述了我们如何通数据库中的数据打交道。
- 存储模型：描述了数据库内部存储及操作数据的机制。
- NoSQL数据模型分类：键值，文档，列族，图。其中前三种模型都有一个共同点--面向聚合
- 关系模型把存储的信息分隔成元祖（行）。元祖是种受限的数据结构：它只能包含一系列的值，因此不能再元祖中嵌套另一个元祖，也不能包含由值或者元祖组成的列表。这种简单的数据结构支撑着关系模型：所有操作都必须以元祖为目标，而其返回值也必须是元祖。
- 聚合是“领域驱动设计”中的术语。在领域驱动设计中，我们想把一组相互关联的对象视为一个整体单元来操作，而这个单元就叫聚合。

## 键值数据模型与文档数据模型

​	键值数据库和文档数据库主要是通过聚合来构建。这两类数据库都包含大量聚合，每个聚合中都有一个获取数据所用的键或ID。

* 键值数据模型与文档数据模型的区别：键值数据库的聚合不透明，只包含一些没有太多意义的大块信息；文档数据库的聚合中，可以看到其结构。
* 不透明的含义是某个数据结构不需知道其内部实现细节即可为外部程序使用
* 键值数据库的好处在于可以随意存储任意数据。文档数据库的好处在于因为对数据结构做了特殊限制，那么访问数据时就更加灵活。
* 键值数据库中查找数据只能通过键来查找。文档数据库可以使用聚合中的字段查找，可以只获取部分聚合，还可以按照聚合内容创建索引。

## 列族存储

​	将所有行的某一列作为基本数据存储单元。

​	理解列族模型最好的方式就是将其视为两级聚合结构。也就是说用两个键来存储数据。与键值数据库的区别在于，通过键获取到的值本身又是一个映射，其中包含一些更为详细的值。

​	列族数据库将列组织为列族。每一列都必须是某个列族的一部分，而且访问数据的单元也得是列。

## 总结

​	面向聚合数据库都使用聚合这一概念，聚合中都有一个可以查找内容的索引建。集群上运行时，聚合内的数据都存放在同一个节点上。聚合是“更新”操作的最小数据单位。

# 数据模型详解

- 无模式数据库：关系型数据库必须定义“模式”，也就是用一种预定义结构向数据库说明：有哪些表格，表中有哪些列，每一列都存放何种类型的数据。必须先定义好模式，然后才能存放数据。NoSQL数据库存储的数据结构比较随意，可以存储任意数据结构的数据。
- 无模式数据库的好处：不用预定义模式，方便扩展需要存储的新数据，方便废弃不需要存储的数据，扩展灵活；更容易处理格式不一致的数据。
- 无模式数据库的缺点：应用程序需要包含“隐含模式”，也就是说应用程序需要编写代码来识别存储的数据的意义，这使得维护应用程序代码变得困难。而且因为数据库不感知模式，无法对数据做自验证，意味着不同程序对数据库的操作可能会不一致。
- 本质上来说，无模式数据库是把模式交由访问其数据的应用程序代码来处理。如果不同应用程序要访问同一个数据库，这将会带来麻烦。解决办法：将对数据库的活动操作封装成独立的应用程序，通过web服务提供给外部调用；或者在聚合中强制划分不同应用程序所使用的区域。
- 构建数据聚合模型师，既要考虑数据的读取方式，也要考虑模型对这些同聚合相关联的数据产生的作用。

# 分布式模型

## 分片

- 宽泛的说，数据分布有两条路径：复制与分片。复制就是将同一份数据拷贝到多个节点；分片则是将不同数据存放在不同节点中。
- 一般来说，数据库的繁忙体现在：不同用户需要访问数据集中的不同部分。在这种情况下，把数据的各个部分存放于不同的服务器中，以此实现横向扩展，该技术就叫分片。
- 分片可以同时提升读取与写入效率。

## 主从

- 把数据复制到多个节点上。其中有一个节点叫做“主节点”，主节点存放权威数据，而且通常负责处理数据更新操作。其余节点叫“从节点”。复制操作就要让从节点与主节点同步。
- 在频繁读取数据集的情况下，“主从复制”最有助于提升数据访问性能。增加更多节点的方式来进行水平扩展，就可以同时处理更多数据读取请求，并且能保证将所有请求都引导至从节点。然而数据库仍受制于主节点处理更新，以及向从节点发布更新的能力。所以在写入操作特别频繁的场合，这样的分布也没有很大的提升数系统性能。
- 主从复制能够增强数据读取的故障恢复能力，主节点出错时，从节点依然可以处理读取请求。但是主节点出错时，数据库无法处理写入操作。

## 对等复制

“主从复制”的故障恢复能力只在从节点出错时体现，不针对主节点，实际上，在这种分布式结构中，主节点仍然是系统的瓶颈和弱点。“对等复制”能够解决这一问题，在这种分布式结构中，没有“主节点”概念，所有“副本”地位相同，都可以接受写入请求，而且丢失其中一个副本，并不影响数据库的访问。

# 一致性

## 更新一致性

- 并发请求下，同一数据的写入操作在分布式系统中可能会导致更新冲突，因为不同用户有可能访问的是不同的数据库节点。
- 在并发环境下维护数据一致性所用的方式通常分为“悲观方式”和“乐观方式”。"悲观方式"就是避免冲突发生，对写入加锁。“乐观方式”就是先让冲突发生，再来处理冲突，版本控制是一种很好的“乐观方式”，其原理类似于SVN的处理方式。

## 读取一致性

- 在两个写入操作之间读取出错误的数据，就会导致读取到的数据和数据库数据不一致。
- NoSQL数据库在面向单一聚合时是支持原子更新操作的。
- 在执行影响多个聚合的更新操作值，会留下一段时间空挡，让客户端有可能在此刻读出逻辑不一致的数据。存在不一致风险的时间长度叫“不一致窗口”。
- 由于节点间的数据复制需要花费时间，不同用户读取到不同节点上的数据副本可能会导致读到的数据不一致，这就是“复制不一致”。
- 更新操作最终还是会传递到所有节点中，这种情况叫做“最终一致性”。

## CAP定理

给定“一致性”、“可用性”、“分区耐受性”这三个属性，我们只能同时满足其中两个属性。

- 可用性：如果客户可以同集群中的某个节点通行，那么该节点就必然能够处理读取和写入操作。
- 分区耐受性：如果发生通信故障，导致整个集群被分割成多个无法互相通信的分区时（也称作“脑裂”），集群仍然可用。
- 实际上，在系统可能会遭遇“分区”状况时，我们需要在“一致性”与“可用性”之间进行权衡。通常会牺牲一点“一致性”来获取某种程度的“可用性”。
- 数据库"ACID"属性保持一致性的关键在于，将请求序列化，使之成为原子的、相互隔离的“工作单元”。

## 仲裁

- 写入仲裁：如果两个相互冲突的写入操作，那么只有其中一个操作能作为超过半数的节点所认可。这就是写入仲裁，即W>N/2。也就是说，参与写入操作的节点数，必须超过副本节点数的一半。副本个数也叫作“复制因子”。
- 读取仲裁：设执行读取操作时所需联系节点数R，确认写入操作所需征询的节点数W，复制因子N，R+W>N时才能保证读取操作的“强一致性”。
- 大多数情况下，将复制因子设为3就能获得足够好的故障恢复能力。